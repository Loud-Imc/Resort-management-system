generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String          @id @default(uuid())
  email                String          @unique
  password             String
  firstName            String
  lastName             String
  phone                String?         @unique
  isActive             Boolean         @default(true)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  commissionPercentage Decimal?        @db.Decimal(5, 2)
  createdById          String?
  idNumber             String?
  idType               String?
  whatsappNumber       String?
  avatar               String?
  auditLogs            AuditLog[]
  agentBookings        Booking[]       @relation("AgentBookings")
  bookings             Booking[]
  reviews              Review[]
  channelPartner       ChannelPartner?
  eventBookings        EventBooking[]
  createdEvents        Event[]         @relation("EventsCreated")
  addedProperties      Property[]      @relation("PropertyAddedBy")
  ownedProperties      Property[]      @relation("PropertyOwner")
  propertyStaff        PropertyStaff[]
  createdBlocks        RoomBlock[]
  roles                UserRole[]
  createdBy            User?           @relation("UserCreator", fields: [createdById], references: [id])
  createdUsers         User[]          @relation("UserCreator")
  notifications        Notification[]
  fcmToken             String?

  @@map("users")
}

model Role {
  id          String           @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  category    RoleCategory     @default(SYSTEM)
  isSystem    Boolean          @default(false)
  propertyId  String?
  permissions RolePermission[]
  property    Property?        @relation("PropertyRoles", fields: [propertyId], references: [id])
  users       UserRole[]

  @@unique([name, propertyId], name: "name_propertyId")
  @@map("roles")
}

model Permission {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  module      String
  createdAt   DateTime         @default(now())
  roles       RolePermission[]

  @@map("permissions")
}

model UserRole {
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       String
  permissionId String
  assignedAt   DateTime   @default(now())
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model RoomType {
  id                 String        @id @default(uuid())
  name               String
  description        String?
  amenities          String[]
  basePrice          Decimal       @db.Decimal(10, 2)
  extraAdultPrice    Decimal       @db.Decimal(10, 2)
  extraChildPrice    Decimal       @db.Decimal(10, 2)
  freeChildrenCount  Int           @default(0)
  maxAdults          Int           @default(2)
  maxChildren        Int           @default(2)
  isPubliclyVisible  Boolean       @default(true)
  images             String[]
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  propertyId             String
  cancellationPolicyText String?
  highlights             String[]      @default([])
  inclusions         String[]      @default([])
  marketingBadgeText String?
  marketingBadgeType String?
  bookings           Booking[]
  reviews            Review[]
  offers             Offer[]
  pricingRules       PricingRule[]
  property           Property      @relation(fields: [propertyId], references: [id])
  rooms              Room[]
  cancellationPolicyId String?
  cancellationPolicy   CancellationPolicy? @relation(fields: [cancellationPolicyId], references: [id])

  @@unique([propertyId, name])
  @@map("room_types")
}

model Offer {
  id                 String   @id @default(uuid())
  name               String
  description        String?
  discountPercentage Decimal  @db.Decimal(5, 2)
  startDate          DateTime
  endDate            DateTime
  isActive           Boolean  @default(true)
  roomTypeId         String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  roomType           RoomType @relation(fields: [roomTypeId], references: [id], onDelete: Cascade)

  @@map("offers")
}

model Room {
  id         String      @id @default(uuid())
  roomNumber String
  floor      Int?
  status     RoomStatus  @default(AVAILABLE)
  isEnabled  Boolean     @default(true)
  notes      String?
  roomTypeId String
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  propertyId String
  bookings   Booking[]
  blocks     RoomBlock[]
  property   Property    @relation(fields: [propertyId], references: [id])
  roomType   RoomType    @relation(fields: [roomTypeId], references: [id])

  @@unique([propertyId, roomNumber])
  @@map("rooms")
}

model RoomBlock {
  id          String   @id @default(uuid())
  reason      String
  startDate   DateTime
  endDate     DateTime
  notes       String?
  roomId      String
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   User     @relation(fields: [createdById], references: [id])
  room        Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@map("room_blocks")
}

model Booking {
  id                      String               @id @default(uuid())
  bookingNumber           String               @unique
  checkInDate             DateTime
  checkOutDate            DateTime
  numberOfNights          Int
  adultsCount             Int
  childrenCount           Int
  baseAmount              Decimal              @db.Decimal(10, 2)
  extraAdultAmount        Decimal              @default(0) @db.Decimal(10, 2)
  extraChildAmount        Decimal              @default(0) @db.Decimal(10, 2)
  taxAmount               Decimal              @default(0) @db.Decimal(10, 2)
  totalAmount             Decimal              @db.Decimal(10, 2)
  isPriceOverridden       Boolean              @default(false)
  overrideReason          String?
  status                  BookingStatus        @default(PENDING_PAYMENT)
  specialRequests         String?
  isManualBooking         Boolean              @default(false)
  roomId                  String
  roomTypeId              String
  userId                  String
  bookingSourceId         String?
  agentId                 String?
  commissionAmount        Decimal              @default(0) @db.Decimal(10, 2)
  couponId                String?
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  confirmedAt             DateTime?
  checkedInAt             DateTime?
  checkedOutAt            DateTime?
  cancelledAt             DateTime?
  abandonedCartSentAt     DateTime?
  reviewRequestSentAt     DateTime?
  channelPartnerId        String?
  cpCommission            Decimal?             @db.Decimal(10, 2)
  cpDiscount              Decimal?             @db.Decimal(10, 2)
  propertyId              String?
  couponDiscountAmount    Decimal              @default(0) @db.Decimal(10, 2)
  offerDiscountAmount     Decimal              @default(0) @db.Decimal(10, 2)
  whatsappNumber          String?
  amountInBookingCurrency Decimal              @default(0) @db.Decimal(10, 2)
  bookingCurrency         String               @default("INR")
  exchangeRate            Decimal              @default(1.0) @db.Decimal(10, 4)
  paidAmount              Decimal              @default(0) @db.Decimal(10, 2)
  paymentOption           BookingPaymentOption @default(FULL)
  paymentStatus           BookingPaymentStatus @default(UNPAID)
  isSeenByProperty        Boolean              @default(false)
  auditLogs               AuditLog[]
  guests                  BookingGuest[]
  agent                   User?                @relation("AgentBookings", fields: [agentId], references: [id])
  bookingSource           BookingSource?       @relation(fields: [bookingSourceId], references: [id])
  channelPartner          ChannelPartner?      @relation("CPReferrals", fields: [channelPartnerId], references: [id])
  coupon                  Coupon?              @relation(fields: [couponId], references: [id])
  property                Property?            @relation(fields: [propertyId], references: [id])
  room                    Room                 @relation(fields: [roomId], references: [id])
  roomType                RoomType             @relation(fields: [roomTypeId], references: [id])
  user                    User                 @relation(fields: [userId], references: [id])
  income                  Income[]
  payments                Payment[]

  @@map("bookings")
}

model BookingGuest {
  id             String   @id @default(uuid())
  firstName      String
  lastName       String
  email          String?
  phone          String?
  age            Int?
  idType         String?
  idNumber       String?
  bookingId      String
  createdAt      DateTime @default(now())
  whatsappNumber String?
  idImage        String?
  booking        Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@map("booking_guests")
}

model BookingSource {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  commission  Decimal?  @db.Decimal(5, 2)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  bookings    Booking[]

  @@map("booking_sources")
}

model PricingRule {
  id              String                @id @default(uuid())
  name            String
  description     String?
  startDate       DateTime
  endDate         DateTime
  adjustmentType  PricingAdjustmentType
  adjustmentValue Decimal               @db.Decimal(10, 2)
  roomTypeId      String?
  isActive        Boolean               @default(true)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  roomType        RoomType?             @relation(fields: [roomTypeId], references: [id])

  @@map("pricing_rules")
}

model Coupon {
  id               String       @id @default(uuid())
  code             String       @unique
  description      String?
  discountType     DiscountType
  discountValue    Decimal      @db.Decimal(10, 2)
  validFrom        DateTime
  validUntil       DateTime
  maxUses          Int?
  usedCount        Int          @default(0)
  minBookingAmount Decimal?     @db.Decimal(10, 2)
  isActive         Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  bookings         Booking[]

  @@map("coupons")
}

model Payment {
  id                String        @id @default(uuid())
  amount            Decimal       @db.Decimal(10, 2)
  currency          String        @default("INR")
  status            PaymentStatus @default(PENDING)
  razorpayOrderId   String?       @unique
  razorpayPaymentId String?       @unique
  razorpaySignature String?
  paymentMethod     String?
  paymentDate       DateTime?
  refundAmount      Decimal?      @db.Decimal(10, 2)
  refundDate        DateTime?
  refundReason      String?
  bookingId         String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  eventBookingId    String?
  netAmount         Decimal?      @db.Decimal(10, 2)
  payoutStatus      PayoutStatus  @default(PENDING)
  platformFee       Decimal?      @db.Decimal(10, 2)
  notes             String?
  booking           Booking?      @relation(fields: [bookingId], references: [id])
  eventBooking      EventBooking? @relation(fields: [eventBookingId], references: [id])

  @@map("payments")
}

model Income {
  id             String        @id @default(uuid())
  amount         Decimal       @db.Decimal(10, 2)
  source         IncomeSource
  description    String?
  date           DateTime      @default(now())
  bookingId      String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  eventBookingId String?
  propertyId     String?
  booking        Booking?      @relation(fields: [bookingId], references: [id])
  eventBooking   EventBooking? @relation(fields: [eventBookingId], references: [id])
  property       Property?     @relation(fields: [propertyId], references: [id])

  @@map("income")
}

model Expense {
  id          String          @id @default(uuid())
  amount      Decimal         @db.Decimal(10, 2)
  description String
  date        DateTime        @default(now())
  categoryId  String
  receipts    String[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  propertyId  String?
  category    ExpenseCategory @relation(fields: [categoryId], references: [id])
  property    Property?       @relation(fields: [propertyId], references: [id])

  @@map("expenses")
}

model ExpenseCategory {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  expenses    Expense[]

  @@map("expense_categories")
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  entity    String
  entityId  String
  oldValue  Json?
  newValue  Json?
  ipAddress String?
  userAgent String?
  userId    String?
  bookingId String?
  createdAt DateTime @default(now())
  booking   Booking? @relation(fields: [bookingId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model Property {
  id                  String            @id @default(uuid())
  name                String
  slug                String            @unique
  type                PropertyType
  description         String?
  address             String
  city                String
  state               String
  country             String            @default("India")
  pincode             String?
  latitude            Decimal?          @db.Decimal(10, 8)
  longitude           Decimal?          @db.Decimal(11, 8)
  email               String
  phone               String
  images              String[]
  coverImage          String?
  amenities           String[]
  policies            Json?
  rating              Decimal?          @db.Decimal(2, 1)
  reviewCount         Int               @default(0)
  isActive            Boolean           @default(true)
  isVerified          Boolean           @default(false)
  ownerId             String
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  addedById           String?
  commissionStatus    CommissionStatus  @default(PENDING)
  marketingCommission Decimal           @default(0) @db.Decimal(10, 2)
  isFeatured          Boolean           @default(false)
  platformCommission  Decimal           @default(10.00) @db.Decimal(5, 2)
  whatsappNumber      String?
  status              PropertyStatus    @default(PENDING)
  categoryId          String?
  baseCurrency        String            @default("INR")
  taxRate             Float             @default(12)
  licenceImage        String?
  gstNumber           String?
  ownerAadhaarNumber  String?
  ownerAadhaarImage   String?
  bookings            Booking[]
  reviews             Review[]
  events              Event[]
  expenses            Expense[]
  incomes             Income[]
  addedBy             User?             @relation("PropertyAddedBy", fields: [addedById], references: [id])
  category            PropertyCategory? @relation(fields: [categoryId], references: [id])
  owner               User              @relation("PropertyOwner", fields: [ownerId], references: [id])
  staff               PropertyStaff[]
  roles               Role[]            @relation("PropertyRoles")
  roomTypes           RoomType[]
  rooms               Room[]
  cancellationPolicies CancellationPolicy[] @relation("PropertyPolicies")
  defaultCancellationPolicyId String?
  defaultCancellationPolicy   CancellationPolicy? @relation("PropertyDefaultPolicy", fields: [defaultCancellationPolicyId], references: [id])

  @@map("properties")
}

model CancellationPolicy {
  id          String   @id @default(uuid())
  name        String
  description String?
  propertyId  String
  rules       Json     // [{ hoursBeforeCheckIn: number, refundPercentage: number }]
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  property    Property @relation("PropertyPolicies", fields: [propertyId], references: [id])
  roomTypes   RoomType[]
  properties  Property[] @relation("PropertyDefaultPolicy")

  @@map("cancellation_policies")
}

model PropertyCategory {
  id          String     @id @default(uuid())
  name        String     @unique
  slug        String     @unique
  icon        String?
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  properties  Property[]

  @@map("property_categories")
}

model PropertyStaff {
  id         String   @id @default(uuid())
  role       String
  propertyId String
  userId     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([propertyId, userId])
  @@map("property_staff")
}

model ChannelPartner {
  id                   String               @id @default(uuid())
  referralCode         String               @unique
  commissionRate       Decimal              @default(10.00) @db.Decimal(5, 2)
  totalPoints          Int                  @default(0)
  availablePoints      Int                  @default(0)
  totalEarnings        Decimal              @default(0) @db.Decimal(12, 2)
  paidOut              Decimal              @default(0) @db.Decimal(12, 2)
  userId               String               @unique
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  authorizedPersonName String?
  businessAddress      String?
  isRateOverridden     Boolean              @default(false)
  organizationName     String?
  partnerType          PartnerType          @default(INDIVIDUAL)
  status               ChannelPartnerStatus @default(PENDING)
  taxId                String?
  accountHolderName    String?
  accountNumber        String?
  bankName             String?
  ifscCode             String?
  notificationPrefs    Json?                @default("{\"emailRewards\": true, \"pushBookings\": true, \"emailReferrals\": true}")
  pendingEarnings      Decimal              @default(0) @db.Decimal(12, 2)
  pendingPoints        Int                  @default(0)
  referralDiscountRate Decimal              @default(5.00) @db.Decimal(5, 2)
  upiId                String?
  walletBalance        Decimal              @default(0) @db.Decimal(12, 2)
  registrationFeePaid  Boolean              @default(false)
  aadhaarImage         String?
  licenceImage         String?
  referrals            Booking[]            @relation("CPReferrals")
  user                 User                 @relation(fields: [userId], references: [id])
  redemptions          CPRewardRedemption[]
  transactions         CPTransaction[]

  @@map("channel_partners")
}

model CPTransaction {
  id               String              @id @default(uuid())
  type             CPTransactionType
  amount           Decimal             @db.Decimal(10, 2)
  points           Int                 @default(0)
  description      String?
  channelPartnerId String
  bookingId        String?
  createdAt        DateTime            @default(now())
  status           CPTransactionStatus @default(FINALIZED)
  channelPartner   ChannelPartner      @relation(fields: [channelPartnerId], references: [id])

  @@map("cp_transactions")
}

model Currency {
  code      String   @id
  symbol    String
  rateToINR Decimal  @db.Decimal(10, 4)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("currencies")
}

model PartnerLevel {
  id             String   @id @default(uuid())
  name           String   @unique
  minPoints      Int      @unique
  commissionRate Decimal  @db.Decimal(5, 2)
  description    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("partner_levels")
}

model Reward {
  id          String               @id @default(uuid())
  name        String
  description String?
  pointCost   Int
  imageUrl    String?
  isActive    Boolean              @default(true)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  redemptions CPRewardRedemption[]

  @@map("rewards")
}

model CPRewardRedemption {
  id               String           @id @default(uuid())
  status           RedemptionStatus @default(PENDING)
  notes            String?
  channelPartnerId String
  rewardId         String
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  channelPartner   ChannelPartner   @relation(fields: [channelPartnerId], references: [id])
  reward           Reward           @relation(fields: [rewardId], references: [id])

  @@map("cp_reward_redemptions")
}

model Event {
  id            String             @id @default(uuid())
  title         String
  description   String?
  date          DateTime
  location      String
  price         String?
  images        String[]
  isActive      Boolean            @default(true)
  status        EventStatus        @default(PENDING)
  organizerType EventOrganizerType @default(PROPERTY)
  propertyId    String?
  createdById   String
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  bookings      EventBooking[]
  createdBy     User               @relation("EventsCreated", fields: [createdById], references: [id])
  property      Property?          @relation(fields: [propertyId], references: [id])

  @@map("events")
}

model Review {
  id          String   @id @default(uuid())
  rating      Int
  comment     String?
  userId      String
  roomTypeId  String?
  propertyId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  user        User     @relation(fields: [userId], references: [id])
  roomType    RoomType? @relation(fields: [roomTypeId], references: [id])
  property    Property @relation(fields: [propertyId], references: [id])

  @@map("reviews")
}

model EventBooking {
  id          String             @id @default(uuid())
  eventId     String
  userId      String
  ticketId    String             @unique
  amountPaid  Decimal            @db.Decimal(10, 2)
  status      EventBookingStatus @default(PENDING)
  guestName   String?
  guestEmail  String?
  guestPhone  String?
  checkedIn   Boolean            @default(false)
  checkInTime DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  event       Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  income      Income[]
  payments    Payment[]

  @@map("event_bookings")
}

enum RoleCategory {
  SYSTEM
  PROPERTY
  EVENT
}

enum RoomStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
  BLOCKED
}

enum BookingStatus {
  PENDING_PAYMENT
  CONFIRMED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
  NO_SHOW
  REFUNDED
}

enum BookingPaymentStatus {
  UNPAID
  PARTIAL
  FULL
}

enum BookingPaymentOption {
  FULL
  PARTIAL
}

enum PricingAdjustmentType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PayoutStatus {
  PENDING
  PAID
  CANCELLED
}

enum IncomeSource {
  ROOM_BOOKING
  EXTRA_GUEST_CHARGES
  ONLINE_BOOKING
  OTHER
  EVENT_BOOKING
  MANUAL_PAYMENT
  CP_REGISTRATION_FEE
}

enum PropertyStatus {
  PENDING
  APPROVED
  REJECTED
  INACTIVE
}

enum PropertyType {
  RESORT
  HOMESTAY
  HOTEL
  VILLA
  OTHER
}

enum PartnerType {
  INDIVIDUAL
  ORGANIZATION
}

enum ChannelPartnerStatus {
  PENDING
  APPROVED
  REJECTED
  INACTIVE
}

enum CPTransactionType {
  COMMISSION
  POINTS_EARNED
  POINTS_REDEEMED
  PAYOUT
  WALLET_TOPUP
  WALLET_PAYMENT
}

enum CPTransactionStatus {
  PENDING
  FINALIZED
  VOID
}

enum RedemptionStatus {
  PENDING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum CommissionStatus {
  PENDING
  PAID
  CANCELLED
}

enum EventStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum EventOrganizerType {
  PROPERTY
  EXTERNAL
}

enum EventBookingStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

model Notification {
  id        String   @id @default(uuid())
  title     String
  message   String
  type      String   // e.g., 'BOOKING_CREATED', 'PAYMENT_SUCCESS', 'SYSTEM'
  isRead    Boolean  @default(false)
  data      Json?    // For storing related IDs like bookingId
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}
